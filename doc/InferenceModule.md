# Topic Mapping Pipeline - 2020 [![CC BY-NC 4.0][cc-by-nc-shield]][cc-by-nc]
# Infer Documents Module

The Infer Documents module is the fifth module of the Topic Mapping Pipeline.It generates the topic distribution of new 
documents from an existing model. For that, it reads a model previously built by the 
[Topic Model module](ModelModule.md) and new documents lemmatised by the [Lemmatise Module](LemmatiseModule.md).
The new distributions are saved in a ***Document JSON file*** and optionally in ***Document CSV file(s)***.
 
The Infer Documents module is contained in the `P3_TopicModelling` package.

## Specifications

mainTopicsOutput //  merge main topis output !opt def to "" (output dir)
mainTopics // main topic json file, req if mainTopicsOutput set, (modelDir)
subTopicsOutput // merge sub topics output !opt def to "" (output dir)
subTopics // sub topic json file, req if subTOpicOutput set, (modelDir)

The Infer Documents module entry in the project file should have the following structure:
```json5
{...
  "inferDocuments": {
    "lemmas": "path",
    "modelDir": "path",
    "documents": "path",
    "mainModel"|"model": "path",
    "subModel": "path",
    "iterations": 1000,
    "outputDir": "path",
    "csvOutput": "path",
    "docFields": ["key", ... ],
    "numWordId": 3,
    "documentOutput": "path",
    "mainTopicsOutput"|"topicOutput": "path",
    "mainTopics"|"topics": "path",
    "subTopicsOutput": "path",
    "subTopics": "path",
  },
...}
```
Where:
- `lemmas` is the path, from the data directory, to the lemmas JSON file (generated by the [Lemmatise module](LemmatiseModule.md))
  containing the documents to infer;
- `modelDir` is the path, from the source directory, to the directory containing all model data files from which the
  documents will be inferred, it is optional and defaults to `""`;
- `documents` is the path, from `modelDir`, to the document JSON file generated by a [Model module](ModelModule.md);
- `model` is the path, from `modelDir`, to the serialised (main) model file generated by a [Model module](ModelModule.md),
  in case you wish to infer documents from a hierarchical model, this field should be `"mainModel`;
- `subModel` is the path, from `modelDir`, to the serialised sub model file generated by a [Model module](ModelModule.md),
  it is optional and the module will not infer documents from the sub model if the parameter is not specified;
- `iterations` lets you defined the number of iteration the inference process must go through, it is optional and will
  default to 100;
- `outputDir` is the path, from the data directory, to the directory that will contain all of the data generated by this
  module, it is optional and defaults to `""`;
- `csvOutput` is the path, from `outputDir`, to the CSV file that will save the topic distributions of the inferred
  documents, it is optional and the module will not save this data the parameter is not specified;
- `docFields` specifies which keys from the `docData` entry of documents should be kept when writing `csvOutput`,
  it defaults to an empty list, note that this list is overwritten by the meta-parameter `docFields`;
- `numWordId` is the number of top labels to use to identify a topic in `csvOutput`, it defaults to `3`;
- `documentOutput` is the path, from `outputDir`, to the document JSON file exporting both the previous model's documents
  and the inferred documents, it is optional and the module will not save this data the parameter is not specified;
- `topicsOutput` is the path, from `outputDir`, to the topic JSON file exporting the model's (main) topics, including the
  inferred documents in their top documents, it is optional and the  module will not save this data the parameter is
  not specified, in case you are infer documents from a hierarchical model, this field should be `"mainTopicsOutput`;
- `topics`, is the path, from `modelDir`, to the (main) topic JSON file generated by a [Model module](ModelModule.md),
  it is required if `topicsOutput` is specified, in case you are infer documents from a hierarchical model, this field
  should be `mainTopics`;
- `subTopicsOutput` is the path, from `outputDir`, to the topic JSON file exporting the model's sub topics, including the
  inferred documents in their top documents, it is optional and the  module will not save this data the parameter is
  not specified;
- `subTopics`, is the path, from `modelDir`, to the sub topic JSON file generated by a [Model module](ModelModule.md),
  it is required if `subTopicsOutput` is specified.

Note that topic distributions will not be inferred from the sub model if the meta-parameter `modelType` is set to
`simple`.

## Output

The Infer Document module can output multiple files.

First, the document JSON file, which follows a similar structure to the document file generated by the
[Topic Model Modules](ModelModule.md):
```json5
{
  "metadata":{...
    "nTopicsMain":20,
    "nTopicsSub":30
  },
  "documents":[
    {
      "docId":"0",
      "docIndex":0,
      "numLemmas":107,
      "docData":{"key": "value", ...},
      "mainTopicDistribution":[ ... ],
      "subTopicDistribution":[ ... ]
    },{
      "docId": "1",
      "docIndex": 1,
      "removed": true,
      "removeReason":"Too short",
      "numLemmas": 2,
      "docData": {"key": "value2", ...}
    },...
  ]
}
```
As with the [Topic Model Modules](ModelModule.md), this file builds on top of the lemma JSON file. To the `metadata`, 
it adds:
- the number of topics in the main model, `nTopicsMain`;
- the number of topics in the sub model, `nTopicsSub`, if a sub model is also used for inference.

To the `documents` it adds (if the documents was not removed):
- `mainTopicDistribution` the list of topic weights from the main model;
- `subTopicDistribution` the list of topic weights from the sub model, if used for inference.

Note that the `docData` will also be adjusted to fit with the `docFields` specification.

Then, the document CSV file(s), if set in the specifications, following this structure:
```csv
"_docId", "key1",   "key2",   ..., "_wordCount", "_includedInModel", "_reasonForRemoval", "_mainTopic_topic-1-labels", "_mainTopic_topic-2-labels", ...
"0",      "value1", "value2", ..., "107",        "true",             "",                  "0.0197",                    "0.0099",                    ...
```
Each row represents a document, with `key1`, `key2`, etc. being the keys set in `docFields`. The CSV also includes the 
`wordCount` per document, whether the document was included in the model or not, and, if not, the reason for its 
removal (e.g. `"Too short"`). Finally, for each topic, identified by a list of their top labels, there is the weight of
that topic in the document. Each topic identifier is also annotated with either `_mainTopic_` or `_subTopic_` to help
identify which model they are from. 

---

[< Previous](ExportModule.md) | [Index](index.md) | [Next >](LabelIndexModule.md)

---
This work is licensed under a [Creative Commons Attribution 4.0 International
License][cc-by-nc].

[![CC BY-NC 4.0][cc-by-nc-image]][cc-by-nc]

[cc-by-nc]: http://creativecommons.org/licenses/by-nc/4.0/
[cc-by-nc-image]: https://i.creativecommons.org/l/by-nc/4.0/88x31.png
[cc-by-nc-shield]: https://img.shields.io/badge/License-CC%20BY--NC%204.0-lightgrey.svg
