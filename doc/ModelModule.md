# Topic Mapping Pipeline - 2020 [![CC BY-NC 4.0][cc-by-nc-shield]][cc-by-nc]
# Topic Model Modules

The Topic Model modules come third on the list of modules in the Topic Mapping pipeline. It uses the lemmas data 
[previously created](LemmatiseModule.md) to create one or more topic model(s) from it. The lemmas data is then saved in
a ***Document JSON file*** and topics are saved in ***Topic JSON file(s)***.

The Topic Model modules are contained in the `P3_TopicModelling` package.

## List of Topic Model Modules

There are two Topic Model modules:
- ***Topic Modelling*** (`TopicModelling.java` class), which samples a single model from the lemmas;
- ***Hierarchical Topic Modelling*** (`HierarchicalTopicModelling.java` class), which samples two separate topic models
(using the Topic Modelling module), a main model and a sub model, and creates an assignment between the two to create 
a two-layers hierarchical model.

## Specifications

The Topic Model module entry in the project file should has the following structure:
```json5
{...
  "model": {
    "lemmas": "path",
    "modelType": "module name",
    "outputDir": "path",
    "documentOutput": "path",
    "mainModel": { ... },
    "subModel": { ... },
    "hierarchy": { ... }
  }
...}
```

Where:
- `lemmas` is the path to the lemmas data (generated by an [Lemmastise module](LemmatiseModule.md));
- `modelType` points to the model to use, it gets overwritten by the `modelType` meta-parameter (if set):
    - `simple` for the basic, non-hierarchical, Topic Modelling module;
    - `hierarchical` for the Hierarchical Topic Modelling module;
- `outputDir` is the path to the output directory for the module, because this module will potentially create numerous
files, a single directory path was added to avoid repeated information;
- `documentOutput` is the path to the document JSON file (excluding directory);
- `mainModel` contains the specification for the topic model (if using the Topic Modelling module), or the main
topic model (if using the Hierarchical Topic Modelling module);
- `subModel` is only necessary if using the Hierarchical Topic Modelling module, and contains the specification for 
the sub topic model;
- `hierarchy` is only necessary if using the Hierarchical Topic Modelling module, and contains the specifications for
the main-sub topics assignment.

The specifiations for `mainModel` and `subModel` follow the same structure:
```json5
{...
  "model":{...
    "mainModel": {
      "topics": 20,
      "words": 10,
      "docs": 30,
      "iterations": 500,
      "iterationsMax": 10,
      "topicOuput": "path",
      "serialise": "path",
      // Advanced options
      "topicSimOutput": "path",
      "numWordId": 3,
      "llOutput": "path",
      "topicLogOutput": "path",
      "alphaSum": 1.0,
      "symmetricAlpha": false,
      "beta": 0.01,
      "seed" : 0
    },
  ...}
...}
```

Where:
- `topics` is the number of topics to sample;
- `words` is the number of top labels to keep in the topic data, it is optional and defaults to `20`;
- `docs` is the number of top documents to keep in the topic data, it is optional and defaults to `20`;
- `iterations` is the number of iterations the Gibbs Sampling algorithm needs to perform, it is optional and defaults 
  to `1000`;
- `iterationsMax` is the number of iteration the maximisation algorithm (after sampling) will perform, it is optional
  and defaults to `0` (no maximisation);
- `topicOuput` is the path to the topic JSON file (excluding directory);
- `serialise` is the path to the serialised model object (excluding directory), which will be used to
[infer topics](InferenceModule.md), using this parameter is optional, and the model won't be serialised if this
parameter is not specified.

There are also advanced specifications:
- `topicSimOuput` is the path to the CSV file saving the topic-to-topic similarity matrix (excluding directory), using
this parameter is optional, and the data won't be saved if this parameter is not specified;
- `numWordId` is the number of labels to use to identify a topic in a similarity matrix output, or hierarchical
assignment output, it is optional and defaults to `3`;
- `llOupout` is the path to the JSON file recording the evolution of the model's log-likelihood throughout the modelling
process, this parameter is optional, and the data won't be saved if it is not specified;
- `topicLogOutput` is the path to the JSON file recording the evolution of topics throughout the modelling process,
this parameter is optional, and the data won't be saved if it is not specified;
- `alphaSum` lets you set the sum of the topics' alpha values (document to topics distribution Dirichlet prior), this 
parameter is optional and defaults to `1.0`;
- `symmetricAlpha` lets you set the symmetry of the alpha values during their optimisation stage, this parameter is
optional and defaults to `false`;
- `beta` lets you set the words' beta values (topic to words distribution Dirichlet prior), this parameter is optional
and defaults to `0.01`;
- `seed` lets you select one of 100 random seed for the model, it must therefore have a value between `0` and `99`
(included), this parameter is optional and defaults to `0`.

The specification for `hierarchy` should follow this structure:
```json5
{...
  "model":{...
    "hierarchy": {
      "modelSimOutput": "path",
      "assignmentType" :  "Perceptual",
      "maxAssign": 1,
      "assignmentOutput": "path"
    },
  ...}
...}
```

Where:
- `modelSimOutput` is the path to the CSV file saving the main-to-sub topic similarity matrix (excluding directory),
using this parameter is optional, and the data won't be saved if this parameter is not specified;
- `maxAssign` is the maximum number of time a sub topic will get assigned to main topics, it is optional and defaults to `1`;
- `assignmentType` is the type of similarity measure to use for the assignment between main and sub topics:
  - `"Perceptual"` will use the overlap between topics' labels, it is the default value;
  - `"Document"` will use the topics' distributions in documents;
- `assignmentOutput` is the path to the CSV file saving the assignment data (excluding directory),
using this parameter is optional, and the data won't be saved if this parameter is not specified.

## Output

The Topic Model modules output multiple files.

First, the document JSON file, which follows a similar structure to the lemmas and corpus files:
```json5
{
  "metadata":{...
    "nTopicsMain":20,
    "nTopicsSub":30
  },
  "documents":[
    {
      "docId":"0",
      "docIndex":0,
      "numLemmas":107,
      "docData":{"key": "value", ...},
      "mainTopicDistribution":[ ... ],
      "subTopicDistribution":[ ... ]
    },{
      "docId": "1",
      "docIndex": 1,
      "removed": true,
      "removeReason":"Too short",
      "numLemmas": 2,
      "docData": {"key": "value2", ...}
    },...
  ]
}
```

In addition to the information from the lemmas file, the `metadata` now also contains:
- the number of topics `nTopicsMain`, if the simple Topic Modelling module was used;
- the number of main topics `nTopicsMain` and sub topics `nTopicsSub`, if the Hierarchical Topic Modelling module
was used.

Then the file has a `documents` list, with one object per document with the following information:
- `docId` the document id;
- `docIndex` the document index;
- `numLemmas` the number of lemmas in that document;
- `docData` the document data that was kept with `docFields`;
- if the document inherited the `removed` and `removeReason` attributes from the lemma file, those are kept;
- otherwise, the document has been used in the topic model(s) and now has topic weights data:
    - `mainTopicDistribution` the list of topic weights, if the simple Topic Modelling module was used;
    - `mainTopicDistribution` the list of main topic weights and `subTopicDistribution` the list of sub topic weights,
    if the Hierarchical Topic Modelling module was used.
    
Second, the topic JSON file(s), either one if using the simple Topic Modelling module, or two if using the 
Hierarchical Topic Modelling module. They roughly follow the same structure:
```json5
{
  "metadata": {...
    "nTopics": 20,
    "nDocs": 20,
    "nWords": 10
  },
  "topics": [
    {
      "topicId": "0",
      "topicIndex": 0,
      "topDocs": [{"docId": "id", "weight": 0.7778}, ... ],
      "topWords": [{"label": "risk", "weight": 85.0}, ... ],
      "subTopicIds": [ ... ],
      "mainTopicIds": [ ... ]
    }, ...
  ],
  "similarities": [ [ ... ], ... ]
}
```

In addition to the metadata from the lemmas JSON file, the following fields are added:
- the number of topics `nTopics`;
- the number of top documents per topic `nDocs`;
- the number of top words per topic `nWords`.

Then, the file has list of `topics`, with one object per topic with the following fields:
- `topicId` the topic id;
- `topicIndex` the topic index, used for example in the documents' topic distributions or in the `topicSimilarity`;
- `topDocs` the top documents for that topic, with their `docId` and `weight`;
- `topWords` the top words for that topic, with their `label` and `weight`;
- if the Hierarchical Topic Modelling module was used, an additional field is added:
    - `subTopicIds`, if this is the main topic JSON file, containing the list of sub topic ids assigned to that main
    topic;
    - `mainTopicIds`, if this the sub topic JSON file, containing the list of main topic ids assigend to that sub
    topic.
    
Finally, the topic JSON file has `similarities` which contains the similarity matrix between the topics in that file.
The matrix is in the form of a list of list of numbers:
```json5
{...
  "similarities": [
    [0-0, 0-1, 0-2, ..., 0-n],
    [1-0, 1-1, 1-2, ..., 1-n],
    [2-0, 2-1, 2-2, ..., 2-n],
    ...,
    [n-0, n-1, n-2, ..., n-n]
  ]
}
```

---

[< Previous](LemmatiseModule.md) | [Index](index.md) | [Next >](ExportModule.md)

---
This work is licensed under a [Creative Commons Attribution 4.0 International
License][cc-by-nc].

[![CC BY-NC 4.0][cc-by-nc-image]][cc-by-nc]

[cc-by-nc]: http://creativecommons.org/licenses/by-nc/4.0/
[cc-by-nc-image]: https://i.creativecommons.org/l/by-nc/4.0/88x31.png
[cc-by-nc-shield]: https://img.shields.io/badge/License-CC%20BY--NC%204.0-lightgrey.svg
